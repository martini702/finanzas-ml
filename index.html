<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Finanzas App</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#111111">

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
margin:0;
background:#f2f2f2;
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
display:flex;
justify-content:center;
transition:0.3s;
}
.app{
width:390px;
min-height:100vh;
background:white;
padding:15px;
box-shadow:0 0 20px rgba(0,0,0,0.1);
}
.card{
background:#fafafa;
padding:12px;
border-radius:12px;
margin-bottom:15px;
box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
button{
background:#111;
color:white;
border:none;
padding:8px 12px;
border-radius:8px;
margin-top:5px;
cursor:pointer;
}
button.secondary{
background:#e0e0e0;
color:black;
}
input,select{
width:100%;
padding:8px;
margin-top:5px;
border-radius:8px;
border:1px solid #ddd;
}
body.dark{background:#121212;color:white;}
body.dark .app{background:#1e1e1e;box-shadow:none;}
body.dark .card{background:#2a2a2a;box-shadow:none;}
body.dark input,body.dark select{background:#333;color:white;border:1px solid #444;}
body.dark button{background:#444;color:white;}
body.dark button.secondary{background:#666;color:white;}
</style>
</head>

<body>

<div class="app">

<div style="text-align:right;margin-bottom:10px;">
<button id="toggleDark">ðŸŒ™</button>
</div>

<h2>Mis Finanzas</h2>

<div class="card">
<button onclick="cambiarAnio(-1)">â—€</button>
<strong id="anioActual"></strong>
<button onclick="cambiarAnio(1)">â–¶</button>
</div>

<div class="card">
<select id="mesSelect" onchange="render()"></select>
</div>

<div class="card">
<h4>Sueldo</h4>
<input id="sueldoInput" placeholder="Ingrese sueldo">
<button onclick="guardarSueldo()">Guardar</button>
<button class="secondary" onclick="eliminarSueldo()">Eliminar</button>
</div>

<div class="card">
<h4>Ahorro</h4>
<input id="ahorroInput" placeholder="Ingrese ahorro">
<button onclick="guardarAhorro()">Guardar</button>
</div>

<div class="card">
<h4>Agregar Gasto</h4>
<input id="descInput" placeholder="DescripciÃ³n">
<input id="montoInput" placeholder="Monto">
<input id="cuotasInput" placeholder="Meses cuotas">
<button onclick="agregarGasto()">Agregar</button>
<button onclick="agregarCuotas()">En cuotas</button>
<button class="secondary" onclick="aplicarATodos()">Aplicar a todos</button>
</div>

<div class="card">
<h4>Gastos del mes</h4>
<table id="tablaGastos"></table>
</div>

<div class="card">
<p>Total Gastos: <span id="totalGastos"></span></p>
<p>Ahorro: <span id="totalAhorro"></span></p>
<p>Disponible: <span id="disponible"></span></p>
</div>

<div class="card">
<canvas id="graficoAhorro"></canvas>
</div>

</div>

<script>

const meses=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
let anio=new Date().getFullYear();
let datos=JSON.parse(localStorage.getItem("finanzas"))||{};

function guardarStorage(){localStorage.setItem("finanzas",JSON.stringify(datos));}

const formatoMoneda=new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0});
function formatoCL(v){return formatoMoneda.format(Number(v||0));}
function limpiarNumero(valor){return Number(String(valor).replace(/\D/g,""))||0;}

function limpiarFormularioGasto(){
  descInput.value="";
  montoInput.value="";
  cuotasInput.value="";
  descInput.focus();
}

function inicializarAnio(a){
if(!datos[a]){
datos[a]={};
for(let i=0;i<12;i++){datos[a][i]={sueldo:0,ahorro:0,gastos:[]};}
}
}

function cambiarAnio(d){anio+=d;inicializarAnio(anio);render();}
function getMes(){return Number(mesSelect.value);}

function guardarSueldo(){
let m=getMes();
let sueldo=limpiarNumero(sueldoInput.value);
for(let i=m;i<12;i++){datos[anio][i].sueldo=sueldo;}
guardarStorage();
render();
}

function eliminarSueldo(){
let m=getMes();
for(let i=m;i<12;i++){datos[anio][i].sueldo=0;}
guardarStorage();
render();
}

function guardarAhorro(){
let m=getMes();
datos[anio][m].ahorro=limpiarNumero(ahorroInput.value);
guardarStorage();
render();
}

function agregarGasto(){
let m=getMes();
let desc=descInput.value;
let monto=limpiarNumero(montoInput.value);
if(!desc||!monto)return;

datos[anio][m].gastos.push({id:Date.now(),desc,monto});
guardarStorage();

limpiarFormularioGasto();
render();
}

function agregarCuotas(){
let mInicial=getMes();
let desc=descInput.value;
let monto=limpiarNumero(montoInput.value);
let cuotas=Number(cuotasInput.value);
if(!desc||!monto||!cuotas)return;

let aTemp=anio,mTemp=mInicial;

for(let i=0;i<cuotas;i++){
inicializarAnio(aTemp);
datos[aTemp][mTemp].gastos.push({id:Date.now()+i,desc,monto});
mTemp++;
if(mTemp>11){mTemp=0;aTemp++;}
}

guardarStorage();

limpiarFormularioGasto();
render();
}

function aplicarATodos(){
let desc=descInput.value;
let monto=limpiarNumero(montoInput.value);
if(!desc||!monto)return;

for(let i=0;i<12;i++){
datos[anio][i].gastos.push({id:Date.now()+i,desc,monto});
}

guardarStorage();

limpiarFormularioGasto();
render();
}

function render(){
inicializarAnio(anio);
anioActual.innerText=anio;
let m=getMes();
let d=datos[anio][m];

sueldoInput.value=d.sueldo?formatoCL(d.sueldo):"";
ahorroInput.value=d.ahorro?formatoCL(d.ahorro):"";

let total=0;
tablaGastos.innerHTML="";
d.gastos.forEach(g=>{
total+=g.monto;
tablaGastos.innerHTML+=`<tr><td>${g.desc} - ${formatoCL(g.monto)}</td></tr>`;
});

let disp=(d.sueldo||0)-total-(d.ahorro||0);

totalGastos.innerText=formatoCL(total);
totalAhorro.innerText=formatoCL(d.ahorro);
disponible.innerText=formatoCL(disp);

actualizarGrafico();
}

let ctx=document.getElementById("graficoAhorro").getContext("2d");
let grafico=new Chart(ctx,{
type:"bar",
data:{labels:meses,datasets:[{label:"Ahorro Mensual",data:Array(12).fill(0)}]},
options:{responsive:true}
});

function actualizarGrafico(){
let ahorroMensual=meses.map((_,i)=>datos[anio][i]?.ahorro||0);
grafico.data.datasets[0].data=ahorroMensual;
grafico.update();
}

function iniciar(){
meses.forEach((m,i)=>{
let opt=document.createElement("option");
opt.value=i;opt.text=m;mesSelect.appendChild(opt);
});
mesSelect.value=new Date().getMonth();
inicializarAnio(anio);
render();
}

iniciar();

document.getElementById("toggleDark").addEventListener("click",()=>{
document.body.classList.toggle("dark");
});

if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('/service-worker.js')
.then(()=>console.log("Service Worker registrado"))
.catch(err=>console.log("Error SW:",err));
}

</script>

</body>
</html>
